# üöÄ Guia de Implementa√ß√£o Frontend - SIGESCON React/TypeScript

## üìñ An√°lise Geral do Estado Atual

### ‚úÖ **Implementa√ß√µes Bem Estruturadas (N√ÉO ALTERAR)**

O frontend React/TypeScript j√° possui uma base s√≥lida com implementa√ß√µes corretas:

1. **Autentica√ß√£o Base** - JWT com localStorage, interceptors HTTP
2. **Sistema de Roteamento** - React Router com prote√ß√£o de rotas
3. **Contexto de Estado** - AuthContext bem estruturado
4. **Dashboards Diferenciados** - Admin, Gestor e Fiscal com roteamento din√¢mico
5. **Sistema de Permiss√µes** - Hook usePermissions com verifica√ß√£o granular
6. **UI Components** - shadcn/ui configurado, componentes consistentes
7. **API Client** - Configura√ß√£o HTTP centralizada com interceptors
8. **Gest√£o de Contratos** - Interface completa com filtros e pagina√ß√£o
9. **Upload de Arquivos** - Sistema de drag-and-drop implementado

---

## üîß **Funcionalidades que PRECISAM SER IMPLEMENTADAS/CORRIGIDAS**

### 1. üîÑ **Sistema de Altern√¢ncia de Perfis - CR√çTICO**

**PROBLEMA IDENTIFICADO**: O frontend tem a estrutura base para altern√¢ncia de perfis, mas n√£o est√° integrado corretamente com o backend.

#### **Backend Dispon√≠vel:**
```
POST /auth/alternar-perfil
GET  /auth/contexto
```

#### **O que implementar:**

**1.1. Interface de Sele√ß√£o de Perfil no Login**
- Quando login retorna `requer_selecao_perfil: true`, mostrar tela de sele√ß√£o
- Usu√°rio deve escolher o perfil inicial antes de acessar o sistema
- Implementar componente `ProfileSelectionScreen.tsx`

**1.2. Dropdown de Altern√¢ncia no NavUser**
- O componente `nav-user.tsx` j√° tem estrutura b√°sica
- **A√á√ÉO NECESS√ÅRIA**: Criar dropdown visual para sele√ß√£o r√°pida de perfil
- Mostrar perfil atual com badge colorido
- Listar perfis dispon√≠veis para troca
- Implementar loading state durante altern√¢ncia

**1.3. Persist√™ncia do Contexto**
- **A√á√ÉO NECESS√ÅRIA**: Ap√≥s altern√¢ncia, atualizar TODO o estado da aplica√ß√£o
- Recarregar dashboard atual
- Atualizar sidebar/navigation
- Disparar refresh em componentes que dependem do perfil

#### **Fluxo Esperado:**
```
1. Login ‚Üí Verifica requer_selecao_perfil
2. Se true: Mostra tela de sele√ß√£o
3. Se false: Vai direto para dashboard
4. No NavUser: Dropdown sempre vis√≠vel para alternar
5. Ap√≥s alternar: Refresh completo da interface
```

---

### 2. üìä **Dashboards com Dados Isolados - ALTA PRIORIDADE**

**PROBLEMA IDENTIFICADO**: Os dashboards est√£o chamando APIs corretas, mas podem n√£o estar respeitando completamente o isolamento de dados.

#### **Backend Dispon√≠vel:**
```
GET /auth/dashboard                          # Dashboard base por perfil
GET /api/v1/dashboard/fiscal/completo        # Dashboard completo do fiscal
GET /api/v1/dashboard/fiscal/minhas-pendencias # Pend√™ncias espec√≠ficas
```

#### **O que implementar:**

**2.1. Valida√ß√£o de Dados por Perfil**
- **Fiscal**: Deve ver APENAS contratos onde √© fiscal/fiscal_substituto
- **Gestor**: Deve ver APENAS contratos onde √© gestor
- **Admin**: V√™ todos os dados

**2.2. Contadores Din√¢micos**
- **A√á√ÉO NECESS√ÅRIA**: Implementar endpoint espec√≠fico para contadores
- Fiscal: "Minhas Pend√™ncias", "Relat√≥rios Enviados", "Contratos Fiscalizados"
- Gestor: "Contratos Gerenciados", "Relat√≥rios Pendentes", "Equipe"
- Admin: "Total Geral", "Pend√™ncias Sistema", "Usu√°rios Ativos"

**2.3. Novo Status "Aguardando An√°lise"**
- **A√á√ÉO NECESS√ÅRIA**: Atualizar dashboard para mostrar novo status
- Adicionar card espec√≠fico para "Aguardando An√°lise" no dashboard admin
- Implementar filtro por este status nas listagens

---

### 3. üìÑ **Sistema de Relat√≥rios e Pend√™ncias - ALTA PRIORIDADE**

**PROBLEMA IDENTIFICADO**: Sistema existe parcialmente, falta integra√ß√£o completa com workflow backend.

#### **Backend Dispon√≠vel:**
```
GET    /api/v1/contratos/{id}/pendencias
POST   /api/v1/contratos/{id}/pendencias
GET    /api/v1/contratos/{id}/pendencias/contador
PATCH  /api/v1/contratos/{id}/pendencias/{id}/cancelar

GET    /api/v1/contratos/{id}/relatorios
POST   /api/v1/contratos/{id}/relatorios
PATCH  /api/v1/contratos/{id}/relatorios/{id}/analise
```

#### **O que implementar:**

**3.1. Fluxo Completo de Pend√™ncias**
- **Tela para Admin**: Criar pend√™ncia para fiscal espec√≠fico
- **Tela para Fiscal**: Listar "Minhas Pend√™ncias" com status visual
- **Workflow**: Pendente ‚Üí Relat√≥rio Enviado ‚Üí Aguardando An√°lise ‚Üí Aprovado/Rejeitado

**3.2. Sistema de Upload de Relat√≥rios**
- **A√á√ÉO NECESS√ÅRIA**: Tela para fiscal enviar relat√≥rio + arquivo
- Integrar com endpoint `POST /api/v1/contratos/{id}/relatorios`
- Suporte a reenvio (substitui arquivo anterior)
- Hist√≥rico de vers√µes

**3.3. Sistema de An√°lise para Admin**
- **A√á√ÉO NECESS√ÅRIA**: Tela para admin analisar relat√≥rios
- Bot√µes "Aprovar" / "Rejeitar"
- Campo para observa√ß√µes em caso de rejei√ß√£o
- Integrar com `PATCH /api/v1/contratos/{id}/relatorios/{id}/analise`

**3.4. Contador de Status no Dashboard**
- **A√á√ÉO NECESS√ÅRIA**: Usar endpoint `/pendencias/contador`
- Exibir: `{"pendentes": 2, "aguardando_analise": 1, "concluidas": 5}`
- Dashboard Admin: Priorizar "Aguardando An√°lise"
- Dashboard Fiscal: Destacar "Pendentes"

---

### 4. üìÅ **Gerenciamento de Arquivos de Contrato - IMPLEMENTA√á√ÉO PARCIAL**

**PROBLEMA IDENTIFICADO**: Upload m√∫ltiplo existe, mas falta gest√£o completa dos arquivos.

#### **Backend Dispon√≠vel:**
```
GET    /api/v1/contratos/{id}/arquivos                     # Lista arquivos
GET    /api/v1/contratos/{id}/arquivos/{arquivo_id}/download # Download seguro
DELETE /api/v1/contratos/{id}/arquivos/{arquivo_id}        # Remove arquivo
GET    /api/v1/arquivos/relatorios/contrato/{id}           # Arquivos de relat√≥rios
```

#### **O que implementar:**

**4.1. Visualizador de Arquivos do Contrato**
- **A√á√ÉO NECESS√ÅRIA**: Componente para listar arquivos do contrato
- Separar "Arquivos Contratuais" de "Arquivos de Relat√≥rios"
- Bot√£o download individual
- Para Admin: Bot√£o excluir arquivo

**4.2. Download Seguro**
- **A√á√ÉO NECESS√ÅRIA**: Implementar download via blob/stream
- Usar endpoint espec√≠fico com verifica√ß√£o de permiss√£o
- Indicador de progresso de download

**4.3. Hist√≥rico de Relat√≥rios**
- **A√á√ÉO NECESS√ÅRIA**: Tela separada para arquivos de relat√≥rios
- Mostrar status: "Aprovado", "Rejeitado", "Pendente de An√°lise"
- Informa√ß√£o de quem enviou e quando

---

### 5. üîê **Controle de Acesso Granular - M√âDIA PRIORIDADE**

**PROBLEMA IDENTIFICADO**: Sistema de permiss√µes existe, mas pode n√£o estar cobrindo todos os casos.

#### **O que verificar/implementar:**

**5.1. Valida√ß√£o Completa por Perfil**
- **A√á√ÉO NECESS√ÅRIA**: Revisar hook `usePermissions.ts`
- Garantir que fiscal n√£o v√™ contratos de outros
- Gestores n√£o veem contratos que n√£o gerenciam
- Admin v√™ tudo

**5.2. UI Condicional**
- **A√á√ÉO NECESS√ÅRIA**: Ocultar bot√µes/a√ß√µes n√£o permitidas
- Exemplo: Fiscal n√£o deve ver bot√£o "Criar Contrato"
- Gestor n√£o deve ver "Gerenciar Usu√°rios"

**5.3. Prote√ß√£o de Rotas Espec√≠ficas**
- **A√á√ÉO NECESS√ÅRIA**: Revisar `ProtectedRoute.tsx`
- Algumas p√°ginas espec√≠ficas podem precisar de prote√ß√£o adicional
- Exemplo: `/admin/*` apenas para Administrador

---

### 6. üîî **Sistema de Notifica√ß√µes - BAIXA PRIORIDADE**

**PROBLEMA IDENTIFICADO**: N√£o implementado no frontend.

#### **Backend Dispon√≠vel:**
Sistema de emails autom√°tico, mas sem notifica√ß√µes em tempo real no frontend.

#### **O que implementar:**

**6.1. Notifica√ß√µes Toast**
- **A√á√ÉO NECESS√ÅRIA**: Expandir uso do sistema toast existente
- Notificar sobre: pend√™ncias vencidas, relat√≥rios aprovados/rejeitados
- Integrar com dados do dashboard

**6.2. Badges de Notifica√ß√£o**
- **A√á√ÉO NECESS√ÅRIA**: Contadores visuais na sidebar
- "Pend√™ncias (3)", "Aguardando An√°lise (2)"
- Atualiza√ß√£o autom√°tica peri√≥dica

---

## üõ†Ô∏è **Instru√ß√µes T√©cnicas Detalhadas**

### **IMPLEMENTA√á√ÉO 1: Sistema de Altern√¢ncia de Perfis**

#### **1.1. Componente de Sele√ß√£o de Perfil**

**Criar arquivo**: `src/components/ProfileSelectionModal.tsx`

**Funcionalidade**: Modal/tela que aparece quando `requer_selecao_perfil: true`

**Integra√ß√£o API**:
```
POST /auth/alternar-perfil
Body: { "novo_perfil_id": 2, "justificativa": null }
Response: ContextoSessao atualizado
```

**Comportamento**:
1. Listar `perfis_disponiveis` do contexto
2. Permitir sele√ß√£o de um perfil
3. Enviar requisi√ß√£o para backend
4. Atualizar estado global
5. Redirecionar para dashboard apropriado

#### **1.2. Dropdown no NavUser**

**Arquivo existente**: `src/components/nav-user.tsx`

**Modifica√ß√µes necess√°rias**:
1. Adicionar dropdown com perfis dispon√≠veis
2. Mostrar perfil atual com badge colorido
3. Implementar fun√ß√£o `handleProfileChange` (j√° existe base)
4. Adicionar loading state durante altern√¢ncia

**Integra√ß√£o API**: Mesma que acima

#### **1.3. Atualiza√ß√£o Global ap√≥s Altern√¢ncia**

**Arquivo principal**: `src/contexts/AuthContext.tsx`

**Modifica√ß√µes necess√°rias**:
1. Ap√≥s altern√¢ncia bem-sucedida, atualizar todo o estado
2. Disparar refresh nos dashboards
3. Atualizar contexto de permiss√µes
4. Notificar componentes filhos sobre mudan√ßa

---

### **IMPLEMENTA√á√ÉO 2: Novo Status "Aguardando An√°lise"**

#### **2.1. Atualiza√ß√£o dos Contadores do Dashboard**

**Arquivos afetados**:
- `src/pages/admin/AdminDashboard.tsx`
- `src/lib/api.ts` (adicionar tipos)

**Nova API necess√°ria**:
```
GET /api/v1/contratos/{id}/pendencias/contador
Response: {
  "pendentes": 2,
  "aguardando_analise": 1,
  "concluidas": 5,
  "canceladas": 0
}
```

**Implementa√ß√£o**:
1. Adicionar card espec√≠fico para "Aguardando An√°lise"
2. Usar cor/√≠cone diferenciado (laranja/amarelo)
3. Fazer card clic√°vel para filtrar contratos

#### **2.2. Filtros de Status Atualizados**

**Arquivo**: `src/pages/contratos/Contratos.tsx`

**Modifica√ß√µes**:
1. Adicionar "Aguardando An√°lise" nos filtros de status
2. Implementar filtro visual para este status
3. Destacar visualmente contratos neste status

---

### **IMPLEMENTA√á√ÉO 3: Sistema Completo de Relat√≥rios**

#### **3.1. Tela de Pend√™ncias do Fiscal**

**Criar**: `src/pages/fiscal/MinhasPendencias.tsx`

**Funcionalidade**:
- Listar pend√™ncias do fiscal logado
- Filtros por status: "Pendente", "Aguardando An√°lise", "Conclu√≠da"
- Bot√£o "Enviar Relat√≥rio" para pend√™ncias pendentes
- Visualizar status de relat√≥rios j√° enviados

**API Integration**:
```
GET /api/v1/dashboard/fiscal/minhas-pendencias
Response: Array de pend√™ncias com detalhes completos
```

#### **3.2. Modal de Envio de Relat√≥rio**

**Criar**: `src/components/RelatorioUploadModal.tsx`

**Funcionalidade**:
- Upload de arquivo (PDF, DOC, XLS)
- Campo para observa√ß√µes
- Suporte a reenvio (substitui√ß√£o)

**API Integration**:
```
POST /api/v1/contratos/{id}/relatorios
FormData: { arquivo: File, observacoes: string }
Response: Relat√≥rio criado/atualizado
```

#### **3.3. Sistema de An√°lise para Admin**

**Criar**: `src/pages/admin/AnalisarRelatorios.tsx`

**Funcionalidade**:
- Listar relat√≥rios pendentes de an√°lise
- Visualizar arquivo enviado
- Aprovar/Rejeitar com observa√ß√µes

**API Integration**:
```
PATCH /api/v1/contratos/{id}/relatorios/{id}/analise
Body: { "aprovado": true/false, "observacoes": "string" }
Response: Status atualizado
```

---

### **IMPLEMENTA√á√ÉO 4: Gerenciamento de Arquivos**

#### **4.1. Componente de Lista de Arquivos**

**Criar**: `src/components/ContratoArquivos.tsx`

**Funcionalidade**:
- Tabela com arquivos do contrato
- Colunas: Nome, Tipo, Tamanho, Data, A√ß√µes
- Bot√£o download para todos
- Bot√£o excluir para Admin

**API Integration**:
```
GET /api/v1/contratos/{id}/arquivos
Response: {
  "arquivos": [...],
  "total_arquivos": 7,
  "contrato_id": 101
}
```

#### **4.2. Download Seguro**

**Fun√ß√£o utilit√°ria**: `src/utils/fileDownload.ts`

**Implementa√ß√£o**:
```typescript
const downloadArquivo = async (contratoId: number, arquivoId: number) => {
  // Usar fetch com blob response
  // Criar URL tempor√°ria
  // Disparar download via elemento <a>
}
```

**API Integration**:
```
GET /api/v1/contratos/{id}/arquivos/{arquivo_id}/download
Response: Blob/Stream do arquivo
```

#### **4.3. Separa√ß√£o de Arquivos Contratuais vs Relat√≥rios**

**Criar**: `src/components/RelatoriosArquivos.tsx`

**Funcionalidade**:
- Lista espec√≠fica para arquivos de relat√≥rios
- Mostrar status do relat√≥rio
- Informa√ß√µes de envio

**API Integration**:
```
GET /api/v1/arquivos/relatorios/contrato/{id}
Response: Arquivos de relat√≥rios com status
```

---

### **IMPLEMENTA√á√ÉO 5: Melhorias de UX**

#### **5.1. Loading States Melhorados**

**Arquivos afetados**: Todos os componentes com chamadas API

**Implementar**:
- Skeleton loading para listagens
- Spinner para a√ß√µes (bot√µes)
- Disable estados durante opera√ß√µes

#### **5.2. Toast Notifications Expandidas**

**Arquivo**: Usar sistema `sonner` existente

**Implementar toasts para**:
- Altern√¢ncia de perfil bem-sucedida
- Upload de relat√≥rio realizado
- Aprova√ß√£o/rejei√ß√£o de relat√≥rio
- Erros de permiss√£o

#### **5.3. Indicadores Visuais**

**Implementar**:
- Badges de status coloridos
- √çcones para diferentes tipos de a√ß√£o
- Contadores em tempo real

---

## üóÇÔ∏è **Estrutura de Arquivos Necess√°ria**

### **Novos Componentes**:
```
src/components/
‚îú‚îÄ‚îÄ ProfileSelectionModal.tsx      # Sele√ß√£o inicial de perfil
‚îú‚îÄ‚îÄ RelatorioUploadModal.tsx       # Upload de relat√≥rios
‚îú‚îÄ‚îÄ ContratoArquivos.tsx           # Lista arquivos do contrato
‚îú‚îÄ‚îÄ RelatoriosArquivos.tsx         # Lista arquivos de relat√≥rios
‚îî‚îÄ‚îÄ StatusBadge.tsx                # Badge reutiliz√°vel para status
```

### **Novas P√°ginas**:
```
src/pages/
‚îú‚îÄ‚îÄ fiscal/
‚îÇ   ‚îú‚îÄ‚îÄ MinhasPendencias.tsx       # Pend√™ncias do fiscal
‚îÇ   ‚îî‚îÄ‚îÄ EnviarRelatorio.tsx        # Tela de envio
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ AnalisarRelatorios.tsx     # An√°lise de relat√≥rios
‚îÇ   ‚îî‚îÄ‚îÄ GerenciarPendencias.tsx    # Criar/cancelar pend√™ncias
‚îî‚îÄ‚îÄ gestor/
    ‚îî‚îÄ‚îÄ RelatoriosEquipe.tsx       # Relat√≥rios da equipe
```

### **Utilit√°rios**:
```
src/utils/
‚îú‚îÄ‚îÄ fileDownload.ts                # Download seguro de arquivos
‚îú‚îÄ‚îÄ statusHelpers.ts               # Helpers para status/cores
‚îî‚îÄ‚îÄ permissionHelpers.ts           # Valida√ß√µes extras de permiss√£o
```

---

## üö® **Prioridades de Implementa√ß√£o**

### **FASE 1 - CR√çTICA (Implementar primeiro)**
1. ‚úÖ Sistema de Altern√¢ncia de Perfis completo
2. ‚úÖ Novo status "Aguardando An√°lise" nos dashboards
3. ‚úÖ Dados isolados por perfil (verifica√ß√£o/corre√ß√£o)

### **FASE 2 - ALTA (Segunda prioridade)**
1. ‚úÖ Sistema completo de Relat√≥rios e Pend√™ncias
2. ‚úÖ Gerenciamento completo de arquivos
3. ‚úÖ Interface de an√°lise para Admin

### **FASE 3 - M√âDIA (Terceira prioridade)**
1. ‚úÖ Melhorias de UX e loading states
2. ‚úÖ Notifica√ß√µes expandidas
3. ‚úÖ Valida√ß√µes extras de seguran√ßa

---

## üìã **Checklist de Valida√ß√£o**

### **Antes de considerar conclu√≠do, verificar:**

#### **Sistema de Perfis**:
- [ ] Login mostra sele√ß√£o quando necess√°rio
- [ ] Dropdown funciona em todos os navegadores
- [ ] Altern√¢ncia atualiza todo o estado
- [ ] Dashboards mudam corretamente
- [ ] Permiss√µes s√£o aplicadas imediatamente

#### **Isolamento de Dados**:
- [ ] Fiscal v√™ apenas seus contratos
- [ ] Gestor v√™ apenas contratos que gerencia
- [ ] Admin v√™ todos os dados
- [ ] Contadores respeitam isolamento
- [ ] Filtros respeitam permiss√µes

#### **Sistema de Relat√≥rios**:
- [ ] Pend√™ncia criada ‚Üí Email enviado ‚Üí Fiscal recebe
- [ ] Relat√≥rio enviado ‚Üí Status atualiza ‚Üí Admin notificado
- [ ] Aprova√ß√£o/Rejei√ß√£o ‚Üí Email para fiscal
- [ ] Reenvio funciona corretamente
- [ ] Hist√≥rico est√° preservado

#### **Gerenciamento de Arquivos**:
- [ ] Upload m√∫ltiplo funciona
- [ ] Download √© seguro e r√°pido
- [ ] Exclus√£o funciona (apenas Admin)
- [ ] Arquivos contratuais ‚â† Arquivos de relat√≥rios
- [ ] Permiss√µes de acesso respeitadas

---

## üéØ **Resultados Esperados Ap√≥s Implementa√ß√£o**

### **Para o Administrador**:
- Dashboard com contadores isolados e precisos
- Gest√£o completa de usu√°rios e perfis
- Sistema de an√°lise de relat√≥rios eficiente
- Controle total sobre pend√™ncias e arquivos

### **Para o Gestor**:
- Vis√£o apenas dos contratos sob sua gest√£o
- Acompanhamento da equipe de fiscais
- Dashboard espec√≠fico com m√©tricas relevantes

### **Para o Fiscal**:
- Lista clara de pend√™ncias atribu√≠das
- Sistema simples de envio de relat√≥rios
- Acompanhamento do status das submiss√µes
- Dashboard focado nas suas responsabilidades

### **Para Todos os Usu√°rios**:
- Altern√¢ncia de perfil fluida e intuitiva
- Interface responsiva e consistente
- Feedback claro sobre todas as a√ß√µes
- Sistema robusto e confi√°vel

---

## ‚ö†Ô∏è **Observa√ß√µes Importantes**

### **Compatibilidade com Backend**:
- Todas as APIs mencionadas j√° est√£o implementadas e testadas
- Estrutura de resposta √© est√°vel e documentada
- Sistema de autentica√ß√£o JWT √© robusto

### **Tecnologias Mantidas**:
- React 18+ com TypeScript
- shadcn/ui para componentes
- Tanstack Router para navega√ß√£o
- Zustand ou Context API para estado global

### **N√£o Modificar**:
- Estrutura base do projeto
- Sistema de build/deploy
- Configura√ß√µes de TypeScript
- Componentes de UI base (shadcn)

### **Testes Necess√°rios**:
- Testar com diferentes perfis
- Validar fluxo completo de relat√≥rios
- Verificar uploads grandes
- Testar altern√¢ncia de perfil em diferentes browsers

---

*Este documento serve como guia completo para implementar todas as funcionalidades faltantes no frontend, mantendo compatibilidade total com o backend FastAPI j√° desenvolvido e testado.*